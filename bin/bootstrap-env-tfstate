#! /bin/bash

set -euo pipefail
source "$(dirname $0)/config.env"

ENV_NAME="${1:-}"
if [[ -z "$ENV_NAME" ]]; then
  echo "Usage: $0 <env>" 1>&2
  exit 1
fi

ENV_DIR="$(dirname $(dirname $0))/env/${ENV_NAME}"
if [[ ! -d "${ENV_DIR}" ]]; then
  echo "${ENV_DIR}: environment directory does not exist" 1>&2
  exit 1
fi

BACKEND_HCL="${ENV_DIR}/backend.hcl"
BACKEND_SECRETS="${ENV_DIR}/backend.secrets.tfvars.enc"
if [[ -e ${BACKEND_HCL} ]]; then
  echo "${BACKEND_HCL}: exists already" 1>&2
  exit 1
fi

SA_NAME="${SA_PREFIX}${ENV_NAME}"
az storage account create -n "$SA_NAME" -g "$TFSTATE_RG" -l "$TFSTATE_LOCATION" --sku Standard_LRS --kind StorageV2
az storage account blob-service-properties update -g "$TFSTATE_RG" -n "$SA_NAME" --enable-versioning true >/dev/null
az storage account blob-service-properties update -g "$TFSTATE_RG" -n "$SA_NAME" --enable-delete-retention true --delete-retention-days "$DELETE_RETENTION_DAYS"
az storage container create --name "$TFSTATE_CONTAINER" --account-name "$SA_NAME"
ACC_KEY="$(az storage account keys list -g "$TFSTATE_RG" -n "$SA_NAME" --query '[0].value' -o tsv)"

cat << EOF > "$BACKEND_HCL"
resource_group_name  = "$TFSTATE_RG"
storage_account_name = "$SA_NAME"
container_name       = "$TFSTATE_CONTAINER"
key                  = "azure-infra/${ENV_NAME}.tfstate"
EOF

cat << EOF > "$BACKEND_SECRETS"
arm_access_key = "$ACC_KEY"
EOF

sops -e -i "$BACKEND_SECRETS"

